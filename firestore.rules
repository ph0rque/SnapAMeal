rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // Users
    // - Any authenticated user can read public user data (for searching).
    // - A user can only create, update, or delete their own user document.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.uid == userId;

      // A user can only manage their own friends list.
      match /friends/{friendId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Chat Rooms
    // - A user can only read/write a chat room if they are a member.
    match /chat_rooms/{chatRoomId} {
      allow read, write: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.members;

      // Messages
      // - A user can only read/write messages in a chat they are a member of.
      match /messages/{messageId} {
        allow read, write: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.members;
      }
    }

    // Snaps
    // - Sender must be the authenticated user.
    // - Only the receiver can read or update (to mark as viewed).
    // - No one can delete a snap (handled by backend).
    match /snaps/{snapId} {
      allow create: if request.auth != null && request.resource.data.senderId == request.auth.uid;
      allow read, update: if request.auth != null && request.auth.uid == resource.data.receiverId;
      allow delete: if false;
    }

    // Stories
    // - A user can only create a story for themself.
    // - Only friends of the user can read the stories.
    // - No one can update or delete (handled by backend).
    function isFriend(userId) {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)/friends/$(userId));
    }

    match /stories/{storyId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (isFriend(resource.data.userId) || request.auth.uid == resource.data.userId);
      allow update, delete: if false;
    }

  }
} 